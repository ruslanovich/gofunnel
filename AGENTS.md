# AGENTS.md

## Что это за репозиторий

Этот репозиторий подготовлен для agent-led разработки SaaS: сначала фиксируем правила, структуру знаний и инварианты, затем на этой базе ведем реализацию сервиса маленькими проверяемыми изменениями.

## Быстрый старт для агента

1. Прочитай индекс базы знаний: `docs/00_index/README.md`
2. Проверь архитектурную рамку: `ARCHITECTURE.md`
3. Найди актуальный план в `docs/03_execution_plans/`
4. Делай маленький PR на один шаг плана

## Где искать требования и планы

- Главный индекс: `docs/00_index/README.md`
- Продуктовые микро-спеки: `docs/01_product/`
- Планы выполнения (execution plans): `docs/03_execution_plans/`
- Архитектурные решения (ADR): `docs/05_decisions/`
- Ранбуки: `docs/04_runbooks/`

## Как работать агенту (обязательно)

- Сначала создай execution plan, затем делай маленькие PR.
- Любое архитектурное изменение оформляй ADR в `docs/05_decisions/`.
- Не добавляй новые папки верхнего уровня без обновления `docs/00_index/README.md`.
- Если меняется поведение продукта, обнови релевантные документы (`docs/01_product/*` и/или `docs/05_decisions/*`).
- Каждый PR должен ссылаться на issue или execution plan.
- Каждый PR должен включать тесты или объяснение, почему тесты не нужны.

## Agent workflow (mandatory)

- До любого кода агент обязан пройти цепочку: research -> decision (если нужен) -> execution plan -> code.
- Repo orientation: прочитать `AGENTS.md` и `docs/00_index/README.md`.
- Local research: найти по репо существующие модули, паттерны, инварианты и ограничения.
- External research: через MCP `context7` проверить актуальную официальную документацию/примеры по используемым библиотекам и фреймворкам.
- Decision: если есть выбор библиотеки/подхода/архитектуры, оформить ADR в `docs/05_decisions/`.
- Execution plan: создать файл плана в `docs/03_execution_plans/` и нарезать работу на PR-sized шаги.
- Только после этого разрешена реализация кода.

## Test-first (default)

- Для изменений поведения (API/auth/токены/валидация/статусы/антиспам/воркер/очередь) сначала добавить/обновить тесты (или первым коммитом в PR), затем делать реализацию.
- Обязательно покрывать негативные сценарии: `401/403/400/404/410`, `expired token`, `disabled user`, `rate-limit (429)`.
- Исключение: UI layout/визуальные правки; допускается нестрогий test-first только с явным объяснением в PR, почему test-first непрактичен, и с минимум одним smoke/regression тестом после правок.

## Стандартный цикл работы

1. Микро-спека в `docs/01_product/`
2. План в `docs/03_execution_plans/YYYY-MM-DD_<slug>.md`
3. Реализация шага плана
4. Тесты / проверки
5. Обновление документации
6. PR по шаблону `.github/PULL_REQUEST_TEMPLATE.md`

## Команды по умолчанию (пока заглушки)

- Lint: `./scripts/lint.sh`
- Test: `./scripts/test.sh`
- Typecheck: `./scripts/typecheck.sh`
- Build: `./scripts/build.sh`
- Repo structure lint: `python3 scripts/repo_lint.py`
- Docs index check: `python3 scripts/docs_index_check.py`
- Architecture boundary check: `python3 scripts/architecture_lint.py`

## Инварианты (source of truth / качество)

- Source of truth находится в репозитории, а не в внешних чатах/заметках.
- Каждый PR обновляет доки/план, если меняет поведение или архитектуру.
- Тесты обязательны для пользовательских сценариев (или требуется явное обоснование).
- Архитектурные границы должны быть задокументированы до внедрения кода.
- Структура репозитория защищается CI и скриптами в `scripts/`.

## Когда создавать ADR

- Новый слой / изменение правил зависимостей
- Новый provider/adapter
- Выбор ключевой библиотеки или инфраструктурного подхода
- Любое решение с долгосрочными последствиями и trade-offs

## Правила для документации

- `docs/00_index/` — карта и навигация
- `docs/01_product/` — краткие спеки и acceptance criteria
- `docs/02_architecture/` — архитектурные рамки и границы
- `docs/03_execution_plans/` — планы исполнения (шаги = потенциальные PR)
- `docs/04_runbooks/` — эксплуатационные инструкции
- `docs/05_decisions/` — ADR и решения
- `docs/06_reference/` — справочные материалы

## Ссылки

- Индекс базы знаний: `docs/00_index/README.md`
- Архитектурная рамка: `ARCHITECTURE.md`
- Процесс изменений: `CONTRIBUTING.md`
- Оценка качества доменов: `QUALITY_SCORE.md`

## Примечание по стеку

Если стек еще не выбран, сначала живут спеки/планы/архитектура. После выбора стека добавляются реальные команды lint/test/typecheck/build и строгие архитектурные линтеры для конкретного языка.
